---
- name: Clonează repositoriul NextJS de pe un branch specific
  git:
    repo: 'https://{{ github_username }}:{{ github_token }}@github.com/dariusbrinzan/Licenta.git'
    dest: '/home/ubuntu/Licenta'
    version: '{{ nextjs_repo_branch }}'
    clone: yes
    update: yes

- name: Construiește imaginea Docker din Dockerfile
  docker_image:
    build:
      path: "./Licenta"
    name: nextjs_license
    tag: "latest"

- name: Verifică dacă imaginea Docker a fost creată
  shell: docker images -q nume_imagine_nextjs:latest
  register: docker_image_check
  failed_when: docker_image_check.stdout == ""

- name: Rulează containerul Docker din imaginea construită
  docker_container:
    name: container_nextjs
    image: nextjs_license:latest
    state: started
    ports:
      - "3000:3000"

- name: Așteaptă 30 de secunde înainte de health check
  pause:
    seconds: 30

- name: Verifică starea de sănătate a aplicației
  uri:
    url: "http://localhost:3000/"
    method: GET
    status_code: 200
    timeout: 5
  register: health_check_response
  until: health_check_response.status == 200
  retries: 5
  delay: 10
